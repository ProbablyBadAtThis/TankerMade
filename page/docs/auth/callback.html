<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Authentication - TankerMade</title>
    <link rel="stylesheet" href="../styles/app.css">
    <link rel="stylesheet" href="../styles/components.css">
</head>
<body>
    <div class="auth-callback-container">
        <div class="card text-center">
            <div class="card-body">
                <div class="spinner mb-4"></div>
                <h2>Completing GitHub Authentication</h2>
                <p class="text-secondary">Please wait while we sign you in...</p>
            </div>
        </div>
    </div>

    <script>
        // Handle OAuth callback
        async function handleCallback() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                const error = urlParams.get('error');

                if (error) {
                    throw new Error(`GitHub OAuth error: ${error}`);
                }

                if (!code) {
                    throw new Error('No authorization code received');
                }

                // Validate state
                const savedState = localStorage.getItem('oauth-state');
                if (state !== savedState) {
                    throw new Error('Invalid OAuth state parameter');
                }

                // Exchange code for token
                const response = await fetch('/api/oauth/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });

                if (!response.ok) {
                    throw new Error('Failed to exchange code for token');
                }

                const { access_token } = await response.json();

                // Store token
                localStorage.setItem('github-token', access_token);
                localStorage.removeItem('oauth-state');

                // Redirect back to main app
                window.location.href = '/';

            } catch (error) {
                console.error('OAuth callback error:', error);

                // Show error and redirect after delay
                document.querySelector('.card-body').innerHTML = `
                    <div class="error-icon">‚ùå</div>
                    <h2>Authentication Failed</h2>
                    <p class="text-secondary">${error.message}</p>
                    <p class="text-sm text-secondary mt-4">Redirecting back to dashboard...</p>
                `;

                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);
            }
        }

        // Run callback handler when page loads
        handleCallback();
    </script>

    <style>
        .auth-callback-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--color-bg-secondary);
            padding: var(--space-6);
        }

        .card {
            max-width: 400px;
            width: 100%;
        }
    </style>
</body>
</html>